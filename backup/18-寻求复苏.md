##### ![image-20241020165031170](./img/image-20241020165031170.png)

### 任务 1：最小化爆炸半径！

#### 背景

------

**在安全事件桥目前处于活动状态的情况下，运行 WordPress 的名为ProductionWebsite**的 Amazon Lightsail 实例目前已被破坏。最终用户在访问该网站时会看到弹出窗口和横幅，当有人尝试抑制弹出窗口时，他们会被重定向到外部域。

#### 你的任务

------

- 观察问题
- 访问 AWS 控制台
- 通过 SSH 协议连接到 Amazon Lightsail 实例
- 检查并修复被破坏的 WordPress 网站

#### 入门

------

- **观察问题**- 导航到“输出属性”并访问 WordPress 网站以观察和识别网站的症状。 可以从“输出属性”选项卡中检索属性名称为**CompromisedInstanceWordpressURL**的 URL 。
- **访问 AWS 控制台**—开始挑战后，单击*“AWS 控制台”按钮访问 AWS 账户。*
- **连接到 Amazon Lightsail 实例 SSH 协议**- 单击此挑战中的*“输出属性”*选项卡，以检索通过 SSH 访问 Amazon Lightsail 实例的直接 URL。该属性将是**CompromisedInstanceSSHAccessURL**
- **检查并修复被破坏的 WordPress 网站**- 一旦建立 SSH 连接，通过积极检查和清理受感染的文件来最大限度地减少爆炸半径。

**笔记：**

- *挑战开始后，实验室大约需要 2 分钟才能完全配置完毕。*
- *恢复 WordPress 网站后，请在新浏览器窗口中访问 Amazon Lightsail 实例的公共 IPv4 URL，以确认 WordPress 网站是否正常运行。可以从\*“输出属性”\*选项卡中检索属性名称为**CompromisedInstanceWordpressURL**的 URL 。*
- *假设这是一个实验室环境，那么 Amazon Lightsail 实例上的 WordPress 网站遵循 HTTP 协议方案。*

#### 存货

------

- Amazon Lightsail 实例名为“ **ProductionWordPress** ”

#### 您应该使用的服务

------

- 亚马逊 Lightsail

#### 任务验证

------

一旦感染文件被清理，且 WordPress 网站恢复正常运行，任务将自动完成。此外，您还可以随时点击挑战详情屏幕中的“检查我的进度”按钮来检查进度。





### 解答：

![image-20241020170124033](./img/image-20241020170124033.png)

![image-20241020170444036](./img/image-20241020170444036.png)

### 线索2：让我们最小化爆炸半径！



------

隐藏

------

##### 访问 Amazon Lightsail 实例

------

要启动恢复过程，我们应该通过 SSH 协议访问 Amazon Lightsail 实例。

- `AWS Console`开始挑战后，单击按钮即可访问 AWS 控制台。
- 访问后，单击`Output Properties`此挑战中的选项卡以检索通过 SSH 访问 Amazon Lightsail 实例的直接 URL。单击显示的相应 URL，这将打开一个带有 SSH 终端的新浏览器窗口。属性名称为**CompromisedInstanceSSHAccessURL**。
- 一旦 SSH shell 在新浏览器窗口上处于活动状态，请按照提到的解决方案进行修复并完成任务。

##### 解决方案——最小化爆炸半径

------

黑客入侵 WordPress 网站有多种症状，但这些症状并非黑客入侵的确切迹象。由于有多种攻击媒介可以破坏和破坏 WordPress 网站，因此定期检查和扫描网站以查找可能的威胁媒介始终必不可少。

让我们首先积极调查有关 Amazon Lightsail 实例的任何线索，这将有助于我们缩小根本原因。请记住，当最终用户访问网站时，会显示一个弹出窗口和一个横幅。这些症状可以将其缩小到受感染的数据库或网站文件。

步骤1：检索过去10分钟内修改的文件。

命令：

```
sudo find /opt/bitnami/wordpress/ -mtime -10
```

*你应该看到类似下面的内容*

输出：

```
...
/opt/bitnami/wordpress/
/opt/bitnami/wordpress/wp-content
/opt/bitnami/wordpress/wp-config.php
/opt/bitnami/wordpress/index.php
/opt/bitnami/wordpress/wp-settings.php
/opt/bitnami/wordpress/wp-includes
/opt/bitnami/wordpress/wp-includes/theme.php
/opt/bitnami/wordpress/wp-includes/n34r.php
/opt/bitnami/wordpress/wp-includes/js/jquery/jquery.min.js
/opt/bitnami/wordpress/wp-includes/n64r.php
...
```

已经注意到这个问题了？目录中有 2 个随机 PHP 脚本文件`n34r.php`，名字相同。网站目录中存在随机文件始终是可能受到攻击的迹象。**注意：****当网站可能受到攻击时，文件可能不会每次都被覆盖，因为对于 Amazon Lightsail 上的 Bitnami WordPress，该文件只能由****用户写入，而不能由默认的 Apache写入****。**`n64r.php``wp-includes`**`wp-config.php``bitnami``daemon`**

让我们清理被报告的受感染文件。我们可以从 WordPress 官方网站下载与已安装的当前版本对应的 WordPress 应用程序包来执行此操作。

步骤 2：检查 Amazon Lightsail 实例上安装的当前 WordPress 版本

命令：

```
sudo cat /opt/bitnami/wordpress/wp-includes/version.php | grep -i '\$wp_version' | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+'
```

*请注意，版本可能会根据 Amazon Lightsail 实例上当前安装的版本而有所不同*

输出：

```
6.5.4
```

步骤 3：下载与上述版本对应的 WordPress 版本并解压存档。

命令：

*注意：将以下命令中的占位符替换`x.x.x`为从上一个命令中检索到的实际版本。*

```
version='6.6.2'sdo curl https://wordpress.org/wordpress-$version.tar.gz -o /tmp/wordpress-$version.tar.gz;
```

命令：

```
tar -xvf /tmp/wordpress-$version.tar.gz -C /tmp
```

步骤 4：让我们通过从下载的档案中手动复制来替换并删除受感染的文件。

命令：

```
cp /tmp/wordpress/index.php /opt/bitnami/wordpress/index.php
cp /tmp/wordpress/wp-settings.php /opt/bitnami/wordpress/wp-settings.php
cp /tmp/wordpress/wp-includes/theme.php /opt/bitnami/wordpress/wp-includes/theme.php
cp /tmp/wordpress/wp-includes/js/jquery/jquery.min.js /opt/bitnami/wordpress/wp-includes/js/jquery/jquery.min.js
```

随着文件被替换，让我们删除被识别的恶意文件`n34r.php`和`n64r.php`

命令：

```
rm -f /opt/bitnami/wordpress/wp-includes/n34r.php
rm -f /opt/bitnami/wordpress/wp-includes/n64r.php
```

步骤 5：替换/删除文件后，让我们通过执行以下命令重新启动 Amazon Lightsail 上的 Bitnami 应用程序堆栈。

命令：

```
sudo /opt/bitnami/ctlscript.sh restart
```

输出：

```
Restarting services..
```

**步骤 6：在新浏览器窗口中访问 Amazon Lightsail 实例的公共 IPv4 URL，以确认 WordPress 网站是否正常运行，并且不会显示横幅和弹出窗口。可以从“输出属性”选项卡中检索属性名称为CompromisedInstanceWordpressURL 的**URL 。

##### 替代解决方案 - 最小化爆炸半径

------

虽然确定在此次入侵中被感染的具体文件可能具有挑战性，但我们可以利用 WordPress 安全插件（如*Sucuri Security*、*All-In-One Security (AIOS)）*来缩小范围并检索当前网站健康状况的综合报告。









### 任务 2：清除恶意用户

![image-20241020174606618](./img/image-20241020174606618.png)

### 线索2：让我们删除流氓用户吧！

------

隐藏

------

##### 访问 Amazon Lightsail 实例

------

要启动恢复过程，我们应该通过 SSH 协议访问 Amazon Lightsail 实例。

- `AWS Console`开始挑战后，单击按钮即可访问 AWS 控制台。
- 访问后，单击`Output Properties`此挑战中的选项卡以检索通过 SSH 访问 Amazon Lightsail 实例的直接 URL。单击显示的相应 URL，这将打开一个带有 SSH 终端的新浏览器窗口。属性名称为**ProductionBlogSSHAccessURL**。
- 一旦 SSH shell 在新浏览器窗口上处于活动状态，请按照提到的解决方案进行修复并完成任务。

您可以按照以下任一解决方案来成功完成任务。

##### 解决方案 1 - 删除恶意用户

------

Amazon Lightsail 上的 Bitnami WordPress 使用默认参数安装，其中包括默认用户。带有用户名的管理员账户`user`是 Bitnami WordPress 上的默认用户账户。

此用户帐户可用于访问 WordPress 管理仪表板并执行日常管理活动。受感染的 WordPress 网站可以创建多个用户，这将为恶意行为者提供访问窗口，从而对网站造成进一步破坏。检测到的任何未知用户帐户都应立即删除。

让我们在新浏览器窗口中激活 SSH shell，以访问 Amazon Lightsail 实例的 WordPress 管理仪表板。

步骤 1：执行以下命令在活动 SSH shell 中检索 WordPress 管理密码。

命令：

```
cat /home/bitnami/bitnami_application_password
```

步骤 2：复制从上一个命令中检索到的凭证。复制后，返回此挑战的输出属性，单击名为**ProductionBlogWordpressAdminURL**的属性显示的 URL 。这是 Amazon Lightsail 实例上的 WordPress 管理仪表板的直接访问 URL。

步骤 3：在页面上输入凭证，用户名是`user`，密码是通过执行上面的命令检索到的`Step 1`。

步骤 4：登录到 WordPress 网站的管理仪表板后，选择**“用户 > 所有用户”**选项。

步骤 5：一旦识别出恶意用户帐户（在本例中它将`armitage`来自用户表），请选择列表中恶意用户旁边的**复选框。**

第 6 步：使用用户表顶部的“批量操作”按钮，从下拉菜单中选择“删除”，然后单击“应用”按钮，进入删除屏幕，其中包含任何适用选项。

第 7 步：单击确认删除按钮以应用更改。

步骤8：刷新页面并确定恶意用户帐户是否仍然存在于用户表中。一旦帐户被删除，任务就完成了。

##### 解决方案 2 - 删除恶意用户

------

另一种方法是使用`wp-cli`，这是 WordPress 的命令行界面。您可以更新插件、配置多站点安装等等，而无需使用 Web 浏览器。

步骤 1：通过执行以下命令列出当前在 WordPress 上活跃的用户。请记住，创建了一个具有管理员权限的恶意用户。

命令：

```
sudo wp user list
```

*注意：您的终端的可视化输出可能会有所不同。*

输出：

```
+----+------------+--------------+------------------+---------------------+---------------+
| ID | user_login | display_name | user_email       | user_registered     | roles         |
+----+------------+--------------+------------------+---------------------+---------------+
| 2  | armitage   | admin admin  | admin@wp.host    | 0000-00-00 00:00:00 | administrator |
| 1  | user       | user         | user@example.com | 0000-00-00 00:00:00 | administrator |
+----+------------+--------------+------------------+---------------------+---------------+
```

具有 user_login/username 的用户`user`是 Amazon Lightsail 上 Bitnami WordPress 的默认管理员用户账户。因此，我们案例中的恶意用户将是`armitage`。

第 2 步：通过执行以下命令删除恶意用户帐户。

命令：

```
sudo wp user delete armitage --yes
```

输出：

```
Success: Removed user 2 from http://127.0.0.1.
```

步骤3：通过执行下面的用户列表命令确认用户是否已被删除。

命令：

```
sudo wp user list
```

*注意：您的终端的可视化输出可能会有所不同。*

输出：

```
+----+------------+--------------+------------------+---------------------+---------------+
+----+------------+--------------+------------------+---------------------+---------------+
| 1  | user       | user         | user@example.com | 0000-00-00 00:00:00 | administrator |
+----+------------+--------------+------------------+---------------------+---------------+
```

删除用户帐户后，您可以继续验证任务。





## 任务三：

![image-20241020173603339](./img/image-20241020173603339.png)  

使用 `lastb` 命令可以显示所有失败的登录尝试，因为它读取 `btmp` 文件。这个文件专门用于记录未成功的登录事件，包括无效用户名和尝试的时间。这对于安全分析至关重要，因为它能帮助您识别潜在的安全威胁和被攻击的模式。通过检查这些记录，您可以了解哪些用户名被尝试过，从而采取适当的防护措施。