# **私有 VPC 中的 EC2 无法通过 SSM 访问**

![image-20241023195448534](./img/image-20241023195448534.png)

### 任务1：你有许可吗？

可能得分：60 线索惩罚：0 **可用得分：60** **获得积分：38**

------

检查我的进度 完全的！

------

尝试使用控制台中的会话管理器连接到 EC2 实例。你做不到！？那么你需要权限吗？（注意：使用最小特权概念来完成此任务）

### 线索

### **罚分：6分**线索1：哪些实体需要权限？

------

隐藏

------

这是你的角色吗？还是实例角色？

### **罚分：7分**线索2：您需要什么权限？

------

隐藏

------

您是否可以为此访问创建 SSM IAM 内联策略？

### **罚分：9分**线索 3：完整答案

------

隐藏

------

对于此任务，EC2 实例已使用缺少与 AWS 服务通信所需权限的实例配置文件启动。`NothingRole`通过创建内联策略来更新实例配置文件。此策略的内容可从该策略中派生`AmazonSSMManagedInstanceCore`。这将授予实例通过 Session Manager 控制台访问所需的权限。





### 任务2：如何与SSM对话？

可能得分：80 线索惩罚：0 **可用得分：80**

------

检查我的进度

------

现在您已将正确的策略添加到 EC2 的实例配置文件中，但仍然无法连接到 SSM。那么，私有 EC2 实例如何与 SSM 通信呢？

### 线索

### **罚分：8分**线索 1：到达终点的手段。

------

隐藏

------

您处于私有 VPC 中...私有实例如何与外界对话？

### **罚分：10分**线索 2：不是 NAT 网关。

------

隐藏

------

这里有一条线索：您无需 Internet 网关或 NAT 网关即可与 AWS 服务通信。

### **罚分：12分**线索 3：完整答案

------

隐藏

------

对于此挑战，EC2 实例位于私有 VPC 中，没有通向外界的路由。根据您的权限，您无法创建 Internet 网关或 NAT 网关。幸运的是，这不是允许与 AWS 服务和 API 建立网络连接的唯一方法。在提供的 VPC 中创建三个 VPC 终端节点：*com.amazonaws.us-east-1.ssm、com.amazonaws.us-east-1.ssmmessages、com.amazonaws.us-east-1.ec2messages。*这些将创建可由此 VPC 内的资源使用的网络路径，并且是 EC2 实例与 Session Manager 通信所需的三个终端节点。并确保我们选择不同的安全组对于此挑战，EC2 实例位于私有 VPC 中，没有通向 Internet 的出站路由。您无权创建 Internet 网关或 NAT 网关。幸运的是，还有其他方法可以启用与 AWS 服务和 API 的网络连接。

为了实现此目的，请在提供的 VPC 内创建三个 VPC 端点：

- `com.amazonaws.us-east-1.ssm`
- `com.amazonaws.us-east-1.ssmmessages`
- `com.amazonaws.us-east-1.ec2messages`

这些端点将建立 VPC 中的资源与 AWS Session Manager 通信所需的网络路径。此外，请确保为 VPC 端点选择不同的安全组，例如使用“默认”安全组。对于 VPC 端点，我们可以使用“默认”安全组。  