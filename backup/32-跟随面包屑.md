题目

![image-20241022125726758](./img/image-20241022125726758.png)

### 任务 1：用户数量

![image-20241022131947415](./img/image-20241022131947415.png)

背景

在开始任何调查时，查找访问模式非常重要。在第一个任务中，您只需提供访问密钥蓝图的用户总数。在找出它的过程中，您将列举访问它的用户。

要执行此任务，您需要检查存储在 Big Wolf 提供的 S3 存储桶中的 CloudTrail 日志。

下载文件、解压缩并将其加载到工具中进行分析具有挑战性。您可以使用 AWS 数据分析服务，避免下载日志。

对于此任务，您将使用 Amazon Athena。确保在从 AWS 管理控制台访问工作组后，您已选择名为 的工作组，请勿使用默认的 .您只需执行一次此操作： https://docs.aws.amazon.com/athena/latest/ug/workgroups-create-update-delete.html#switching-workgroupsInvestigatorprimary

任务

此任务的答案是访问密钥蓝图的 IAM 用户数。

库存

- VPC 流日志和 CloudTrail 日志已复制到带有前缀的 S3 存储桶中以供分析。darkforrest-logs
- 密钥蓝图文件已还原到 S3 存储桶，名称以 .在 CloudTrail 日志中，您将看到对具有不同后缀的 S3 存储桶的访问。dark-forrest-assets
- Athena Workgroup 、 数据库 、 表 和Investigatorbigwolfdatabasecloudtrailtablevpcflowlogtable

服务业

- Amazon Athena：查询 AWS CloudTrail 和 VPC 流日志
- Amazon S3：AWS CloudTrail 和 VPC 流日志的存储

**蛛丝马迹**

**罚分： 2 点**

线索 1：使用 Athena 查询 S3 中的 CloudTrail 日志

 

隐藏

 

使用 Athena 查询 S3 中的 CloudTrail 日志

- 密钥蓝图存储在多个     S3 存储桶中，前缀为dark-forrest-assets
- 仅列表IAM     Users
- CloudTrail     元素包含您要查找的信息：userIdentity
  - https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-event-reference-user-identity.html
- 帮助您构建 Athena 查询的参考：
  - https://docs.aws.amazon.com/athena/latest/ug/ddl-sql-reference.html
- S3 API 调用参考：
  - https://docs.aws.amazon.com/AmazonS3/latest/API/API_Operations_Amazon_Simple_Storage_Service.html

**罚分： 2 点**

线索 2：第一个 Athena 查询

 

隐藏

 

- 转到 Athena     控制台，确保是所选的工作组Investigator
- 这是帮助您入门的第一个查询：

-- Lists IAM Users accessing S3 using GetObject and PutObject actions
 SELECT useridentity.username as user, requestparameters
 FROM "bigwolfdatabase"."cloudtrailtable"
 WHERE (eventname = 'GetObject'
    OR eventname = 'PutObject')
    AND useridentity.type = 'IAMUser'
 GROUP BY useridentity.username, requestparameters
 ORDER BY user;

**罚分： 3 点**

线索 3：完成攻略

 

隐藏

 

- 密钥蓝图存储在多个     S3 存储桶中，前缀为dark-forrest-assets
- 仅列表IAM     Users
- CloudTrail     元素包含您要查找的信息：userIdentity
  - https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-event-reference-user-identity.html
- 帮助您构建 Athena 查询的参考：
  - https://docs.aws.amazon.com/athena/latest/ug/ddl-sql-reference.html
- S3 API 调用参考：
  - https://docs.aws.amazon.com/AmazonS3/latest/API/API_Operations_Amazon_Simple_Storage_Service.html
- 转到 Athena     控制台，确保是所选的工作组。Investigator
- 按顺序运行每个查询并分析结果。

答案是 4

-- Lists IAM Users accessing S3 using GetObject and PutObject actions
 SELECT useridentity.username as user, requestparameters
 FROM "bigwolfdatabase"."cloudtrailtable"
 WHERE (eventname = 'GetObject'
    OR eventname = 'PutObject')
    AND useridentity.type = 'IAMUser'
 GROUP BY useridentity.username, requestparameters
 ORDER BY user;

 

| **用户** | **request****参数**                                          |
| -------- | ------------------------------------------------------------ |
| 奶奶     | {“bucketName”：“dark-forrest-assets-734”，“Host”：“dark-forrest-assets-734.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 奶奶     | {“bucketName”：“dark-forrest-assets-352”，“Host”：“dark-forrest-assets-352.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 奶奶     | {“bucketName”：“dark-forrest-assets-543”，“Host”：“dark-forrest-assets-543.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 奶奶     | {“bucketName”：“dark-forrest-assets-673”，“Host”：“dark-forrest-assets-673.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 奶奶     | {“bucketName”：“dark-forrest-assets-903”，“Host”：“dark-forrest-assets-903.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 奶奶     | {“bucketName”：“dark-forrest-assets-194”，“Host”：“dark-forrest-assets-194.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 格莱托   | {“bucketName”：“dark-forrest-assets-734”，“Host”：“dark-forrest-assets-734.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 格莱托   | {“bucketName”：“dark-forrest-assets-194”，“Host”：“dark-forrest-assets-194.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 格莱托   | {“bucketName”：“dark-forrest-assets-543”，“Host”：“dark-forrest-assets-543.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 格莱托   | {“bucketName”：“dark-forrest-assets-673”，“Host”：“dark-forrest-assets-673.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 格莱托   | {“bucketName”：“dark-forrest-assets-903”，“Host”：“dark-forrest-assets-903.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 格莱托   | {“bucketName”：“dark-forrest-assets-352”，“Host”：“dark-forrest-assets-352.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 汉斯     | {“bucketName”：“dark-forrest-assets-352”，“Host”：“dark-forrest-assets-352.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 汉斯     | {“bucketName”：“dark-forrest-assets-194”，“Host”：“dark-forrest-assets-194.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 汉斯     | {“bucketName”：“dark-forrest-assets-734”，“Host”：“dark-forrest-assets-734.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 汉斯     | {“bucketName”：“dark-forrest-assets-673”，“Host”：“dark-forrest-assets-673.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 汉斯     | {“bucketName”：“dark-forrest-assets-903”，“Host”：“dark-forrest-assets-903.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 汉斯     | {“bucketName”：“dark-forrest-assets-543”，“Host”：“dark-forrest-assets-543.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 狼       | {“bucketName”：“dark-forrest-assets-543”，“Host”：“dark-forrest-assets-543.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 狼       | {“bucketName”：“dark-forrest-assets-673”，“Host”：“dark-forrest-assets-673.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 狼       | {“bucketName”：“dark-forrest-assets-734”，“Host”：“dark-forrest-assets-734.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 狼       | {“bucketName”：“dark-forrest-assets-194”，“Host”：“dark-forrest-assets-194.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 狼       | {“bucketName”：“dark-forrest-assets-352”，“Host”：“dark-forrest-assets-352.s3.amazonaws.com”，“key”：“姜饼屋”} |
| 狼       | {“bucketName”：“dark-forrest-assets-903”，“Host”：“dark-forrest-assets-903.s3.amazonaws.com”，“key”：“姜饼屋”} |

-- Same as above plus extration of S3 Bucket names using presto functions
 SELECT useridentity.username as user, json_extract_scalar(requestparameters, '$.bucketName') AS bucketname
 FROM "bigwolfdatabase"."cloudtrailtable"
 WHERE (eventname = 'GetObject'
    OR eventname = 'PutObject')
    AND useridentity.type = 'IAMUser'
 GROUP BY useridentity.username, json_extract_scalar(requestparameters, '$.bucketName')
 ORDER BY user;

 

| **用户** | **存储桶名称**          |
| -------- | ----------------------- |
| 奶奶     | dark-forrest-assets-543 |
| 奶奶     | 暗-福雷斯特-资产-673    |
| 奶奶     | 黑暗-福雷斯特-资产-903  |
| 奶奶     | 黑暗-福雷斯特-资产-194  |
| 奶奶     | dark-forrest-assets-352 |
| 奶奶     | 暗-福雷斯特-资产-734    |
| 格莱托   | 暗-福雷斯特-资产-734    |
| 格莱托   | dark-forrest-assets-543 |
| 格莱托   | dark-forrest-assets-352 |
| 格莱托   | 黑暗-福雷斯特-资产-903  |
| 格莱托   | 黑暗-福雷斯特-资产-194  |
| 格莱托   | 暗-福雷斯特-资产-673    |
| 汉斯     | 暗-福雷斯特-资产-673    |
| 汉斯     | 黑暗-福雷斯特-资产-194  |
| 汉斯     | dark-forrest-assets-352 |
| 汉斯     | dark-forrest-assets-543 |
| 汉斯     | 暗-福雷斯特-资产-734    |
| 汉斯     | 黑暗-福雷斯特-资产-903  |
| 狼       | 黑暗-福雷斯特-资产-194  |
| 狼       | dark-forrest-assets-543 |
| 狼       | 黑暗-福雷斯特-资产-903  |
| 狼       | 暗-福雷斯特-资产-673    |
| 狼       | 暗-福雷斯特-资产-734    |
| 狼       | dark-forrest-assets-352 |

-- Lists only the IAM User names
 SELECT useridentity.username as user
 FROM "bigwolfdatabase"."cloudtrailtable"
 WHERE (eventname = 'GetObject'
    OR eventname = 'PutObject')
    AND useridentity.type = 'IAMUser'
    AND json_extract_scalar(requestparameters, '$.bucketName') LIKE 'dark-forrest-assets%'
 GROUP BY useridentity.username
 ORDER BY user;

 

| **用户** |
| -------- |
| 奶奶     |
| 格莱托   |
| 汉斯     |
| 狼       |

 

来自 <https://jam.awsevents.com/event-10-22/challenges/respond-ec-2-compromise?i=1&t=details-1> 