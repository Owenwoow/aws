## 任务 1：让我们追踪 VPC-1 如何接入互联网

![image-20241021101715647](./img/image-20241021101715647.png)

![image-20241021101728403](./img/image-20241021101728403.png)

## 任务 2：Transit Gateway 内部发生什么？

![image-20241021101747137](./img/image-20241021101747137.png)

找到连接互联网的中转网关挂在id



## 任务 3：Egress VPC 有什么特别之处？

![image-20241021102224214](./img/image-20241021102224214.png)

### 任务验证

**将下一个路由跳的资源 ID**输入到答案字段中以进行任务验证。

![image-20241021102800623](./img/image-20241021102800623.png)

## 任务四：修复

### 背景

您推断出 Internet 网关是离开 NAT 网关后的流量去往的地方，并为自己能够追踪请求路径而松了一口气！

就在您开始担心追踪返回路径时，您收到了 DocSkimmaz 发来的一封电子邮件。但 DocSkimmaz 给您准备了一个惊喜。阅读电子邮件以了解更多信息。

**天：倒数第二天**
**子：请修复，谢谢。**

*尊敬的 AWS 工程师：*

*附上一个流量流程图，解释集中式出口设置。如前所述，我们尝试过安全组，但似乎不起作用。
您可以查看它，但我们建议您不要对其进行任何更改。哦！我们有没有提到我们不喜欢 NACL？*

*注意：我们已经配置了对两个 EC2 实例的会话管理器访问权限，以便您可以在进行任何更改后测试 VPC 之间的连接。*

*希望您能尽快修复此问题！*

**谢谢**，
**DocSkimmaz 团队负责人，**
*从我的站立式办公桌发送*

![img](./img/Task4_Image.png)



### 入门

首先确认问题。登录一个 EC2 服务器并 ping 另一个 VPC 中的 EC2 服务器。使用图表观察流量的响应路径并记下路由跳数（就像跟踪请求路径时所做的那样）

**通过 Amazon EC2 控制台使用会话管理器连接到 Linux 实例**
打开 Amazon EC2 控制台https://console.aws.amazon.com/ec2/

1. 在导航窗格中，选择**Instances (实例)**。
2. 选择实例并选择**“连接”**。
3. 对于**连接方法**，选择**会话管理器**。
4. 选择**“连接”**。

**测试**

连接到 VPC1 实例并 ping VPC2 实例
`ping 10.0.1.10`
连接到 VPC2 实例并 ping VPC1 实例
`ping 10.0.0.10`

您将能够看到 ping 回复。

### 你的任务

找到一种方法来阻止 VPC-1 和 VPC-2 之间的流量。您的解决方案还应阻止 VPC-1 和 VPC-2 中未来的 EC2 实例之间的通信，而无需采取任何额外步骤。（即使稍后添加了新子网）

### 您应该使用的服务

AWS Transit Gateway

### 任务验证

解决问题后，重复 **“入门”**部分中的步骤，您应该看不到 ping 回复。

一旦解决问题，任务将自动验证，此外，您可以随时按“检查我的进度”按钮检查您的进度。

![image-20241021110756983](./img/image-20241021110756983.png)

![image-20241021110835399](./img/image-20241021110835399.png)



### 线索 1

------

隐藏

------

为了全面了解该问题：

1. 从一台服务器 ping 另一台服务器。例如：在 VPC1-Instance 上
   执行`ping 10.0.1.10`
2. 在目标服务器（VPC2-Instance）上，使用**tcpdump** 观察流量 `sudo tcpdump -i eth0 icmp`

观察目标服务器看到的流量的实际来源（IP）。您可以使用以下方法识别此 IP 地址的所有者。

**要查找拥有 IP 地址的网络接口**：

1. 打开[Amazon Elastic Compute Cloud (Amazon EC2) 控制台](https://console.aws.amazon.com/ec2/)。
2. 在导航窗格中，选择网络接口。
3. 单击搜索框，然后选择主要私有 IPv4 地址。
4. 在搜索框中输入您要查找的 IP 地址。系统会显示符合搜索条件的网络接口。
5. 在底部窗格中，阅读网络接口的描述以识别拥有该接口的资源。

尝试根据这些信息了解流量流向并进行必要的路由更改。





#### 线索2

#### 解释

发生此问题是因为从 VPC-1 到 VPC-2 的流量经过 NAT-GW。这是因为从 VPC-1 到 VPC-2 的流量使用 TGW 路由表中的 0.0.0.0/0 路由，该路由将其引导至 NAT-GW。虽然此路由用于互联网流量，但它也可以引导至“任何”目的地。为了避免此行为，我们需要使用更具体的路由（本例中为 VPC1 和 VPC2 网络）捕获流量并将其黑洞化。请参阅[路由优先级](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Route_Tables.html#route-tables-priority)

![image-20241021110946451](./img/image-20241021110946451.png)

**从 VPC1 实例到 VPC2 实例的流量的 NAT：**
NAT-GW 在将请求流量发送到 VPC2 实例之前转换 VPC1 实例的源 IP。VPC2 实例认为该流量源自 NATGW 的私有 IP。
因此，响应流量被发送到 NATGW。NATGW 在将源 IP 地址更改为 VPC2 实例的 IP 地址后将此响应流量转发到实际目的地。对于 VPC-1 实例来说，整个过程是透明的。它将流量发送到 VPC2 实例并从其接收响应。

**NAT 如何绕过安全组**
当前的安全组规则没有区别，因为您会看到来自 EgressVPC（包含 NAT 网关）的流量在入站方向同时允许 VPC1 实例和 VPC2 实例。此外，它允许 VPC-1 实例将流量发送到 VPC2 实例，反之亦然，这是出站规则的一部分。

#### 解决方案

**防止VPC-1到达VPC-2**
打开**vpc1-tgw-rt**，并添加到VPC-2的黑洞路由，即10.0.1.0/24

1. 打开 Amazon VPC 控制台https://console.aws.amazon.com/vpc。
2. 在导航窗格上，选择**Transit Gateway Route Tables**。
3. 选择 **vpc1-tgw-rt**路由表。
4. 选择**操作、创建静态路由**。
5. **在创建静态路由**页面上，输入 CIDR 块为**10.0.1.0/24**，然后选择**Blackhole**。
6. 选择**创建静态路由**。
![image-20241021110850638](./img/image-20241021110850638.png)

![image-20241021110910240](./img/image-20241021110910240.png)
**为了防止VPC-2到达VPC-1**
开启**vpc2-tgw-rt**，并添加到VPC-1的黑洞路由，即10.0.0.0/24

1. 打开 Amazon VPC 控制台https://console.aws.amazon.com/vpc。
2. 在导航窗格上，选择**Transit Gateway Route Tables**。
3. 选择 **vpc2-tgw-rt**路由表。
4. 选择**操作、创建静态路由**。
5. **在创建静态路由**页面上，输入 CIDR 块为**10.0.0.0/24**，然后选择**Blackhole**。
6. 选择**创建静态路由**。

通过 ping 进行验证。更改可能需要一段时间才能反映出来