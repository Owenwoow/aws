**回复：链接我的服务**

### 任务 1：排除消费者端故障

可能得分：75 线索惩罚：-16 **所得分数：59**

------

检查我的进度 完全的！

------

#### 背景

作为服务提供商，您正在为一位 ShareZone 客户排除错误。该客户最近更改了其安全状态，现在他们无法访问您服务的网页，并收到连接超时错误。您的客户要求您通过提供对其 Amazon Virtual Private Cloud (Amazon VPC) 中的 EC2 实例及其 VPC 配置的访问权限来解决此问题。

在这个挑战中，您可以访问两个 VPC - 您自己的（服务提供商）和客户（服务消费者）。以下是有关设计的一些细节：

**服务提供商：**

- 该应用程序托管在三个 Amazon EC2 实例上，`VPC B - Service Provider`每个可用区 (AZ) 一个 EC2 实例。
- 入口流量使用网络负载均衡器进行负载均衡，该负载均衡器在 中注册到 AWS Endpoint Service `VPC B - Service Provider`。

**服务消费者：**

- AWS 端点接口部署在三个位于独立私有子网中的弹性网络接口 (ENI) 上，每个子网位于不同的可用区内`VPC A - Service Consumer`。
- 使用`ConsumerInstance`来`VPC A - Service Consumer`测试与端点接口的连接。

#### 架构图

![image-20241020163207630](./img/image-20241020163207630.png) （点击图片在新标签页中打开）](https://aws-jam-challenge-resources.s3.amazonaws.com/networking-private-link/Architecture-Diagram-v6.png)

# 

#### 你的任务

要成功完成任务，您必须通过两个端点接口解决连接问题。您应该完成以下任务：

- 当向域发出 cURL 时，接收 200 OK HTML 响应代码`EndpointInterface`。尝试多次运行该命令，以确保您从*两个*端点接口 IP 都获得 200 OK。

  注意：`EndpointInterfaceDomain`DNS 名称目前将解析 3 个端点接口 IP 中的 2 个。*您将在下一个任务中处理服务提供商配置时单独解决此问题。*

  以下是您应该看到的[示例输出，表明问题已得到解决。](https://aws-jam-challenge-resources.s3.amazonaws.com/networking-private-link/Task1-op.png)

  ![image-20241020163226706](./img/image-20241020163226706.png)

#### 入门

- 使用在 EC2 控制台中启动的会话管理器连接到`ConsumerInstance`Amazon EC2 实例。
- 对于第一个任务，请尝试使用`dig EndpointInterfaceDomain`来检查端点接口域名的 DNS 解析。*（提醒 - 它目前只能解析 2 个 IP。这将在任务 2 中解决。）*
- 接下来，发出`curl -Iv http://EndpointInterfaceDomain`并检查响应。
  - 您可以在此页面左侧的**“输出属性”**`EndpointInterfaceDomain`下找到。
  - *cURL 代表“客户端 URL”，用于通过 URL 传输数据。*

# 

- 其他注意事项：
  - 配置防火墙规则时使用 AWS 最佳实践。
    - 防火墙规则不应允许所有协议和端口流量。
  - 从实例级别和子网级别的安全角度思考。

#### 存货

###### **服务消费者**

- **VPC**：名称 -**服务消费者 VPC**，CIDR - 10.0.0.0/16

  - 子网

    - 子网 1：名称 - ConsumerPrivateSubnet1，CIDR - 10.0.1.0/24

    - 子网 2：名称 - ConsumerPrivateSubnet2，CIDR - 10.0.2.0/24

    - 子网 3：名称 - ConsumerPrivateSubnet3，CIDR - 10.0.3.0/24

      # 

- **消费者端点接口：**

  - **名称 - 参考输出属性**`EndpointInterfaceId`中的值
  - **端点域名 - 请参阅输出属性**`EndpointInterfaceDomain `中的值
  - 端点接口有 3 个弹性网络接口 (ENI)，每个消费者私有子网中各有 1 个。

# 

- 消费者实例：
  - 名称 - ConsumerInstance
  - 私有 IP：10.0.0.11
  - AWS Systems Manager 代理（SSM 代理）已安装。

#### 您应该使用的服务：

- Amazon 虚拟私有云 (VPC)
- Amazon 弹性计算云 (Amazon EC2)

#### 任务验证

### 线索一：规则

------

隐藏

------

考虑适用于子网和 EC2 实例级别的防火墙规则。

你明白了！安全组（在实例级别）和网络访问控制列表（在子网级别）。

在安全组和网络 ACL 中添加规则时不要太过随意。只允许需要的流量。

*注意：使用 0.0.0.0/0 或较大范围的端口可能在技术上“修复”连接问题，但如果不遵循最佳实践，任务 1 将不会自动完成。*



### **罚分：9分**线索2：如何做？

------

隐藏

------

##### 步骤 1 - 修复防火墙规则

1. 导航到**VPC 控制台**

2. **从“安全”**下的左侧菜单中选择**“网络 ACL”**。

3. 选择附加到端点接口上启用的子网**的消费者私有子网 ACL 。**

4. 在页面底部，选择**入站规则**，然后单击**编辑入站规则**。

5. 点击**添加新规则**，并配置如下：

   - **规则 #**为**9**

   - **类型**为**“HTTP (80)”**

   - **源**为**10.0.0.0/16**

   - 保留**“允许”**以执行**“允许/拒绝”**操作

   - 单击

     “保存更改”

     。

     # 

6. 接下来，从页面的同一底部选择“**出站规则”**，然后单击**“编辑出站规则”**。

7. 点击**添加新规则**，并配置如下：

   - **规则 #**为**9**

   - **类型**的**自定义 TCP 规则**

   - **端口范围**为**1024-65535**

   - **目的地**为**10.0.0.0/16**

   - 保留**“允许”**以执行**“允许/拒绝”**操作

   - 点击

     “保存更改”

     # 

8. 现在该检查端点接口的安全组了。单击VPC 控制台中**“安全”**下左侧面板上的**“安全组” 。**

9. **选择名为'Consumer Endpoint Interface SG' 的**安全组，进入页面下方的**Inbound rules标签页，选择****Edit inbound rules**，点击**Add rule**，进行如下配置：

   - 类型选择**HTTP******

   - **将来源**保留为**自定义**

   - 在**源**字段中添加消费者 VPC CIDR 范围**10.0.0.0/16**。

   - 点击

     保存规则

     # 

10. 由于安全组是有状态的，因此您无需在出站规则中添加规则。在一个方向上设置规则会自动允许返回流量

    ------

##### 第 2 步 - 验证消费者实例的连接性

1. 现在防火墙规则已经到位，请导航回消费者实例以验证通信是否成功。
2. 打开 EC2 控制台，选择左侧的**“实例”**`ConsumerInstance` ，勾选旁边的“连接” ，选择控制台顶部的**“连接” 。**
3. 如果尚未显示，请选择**“会话管理器”选项卡。单击****“连接”**以启动与 EC2 实例的会话。
4. 输入命令`curl -Iv http://EndpointInterfaceDomain`并检查响应。请务必将其替换`EndpointInterfaceDomain`为您环境的实际 DNS 名称。此值可在此窗口中任务概览页面左侧的**“输出属性”部分中找到。**
5. 发出该命令 2-4 次。您应该会看到来自两个不同 IP 地址的响应，表明连接成功。
6. 如果回复成功，则该任务很可能已被标记为完成。如果没有，您也可以点击此页面顶部的**“检查我的进度”手动运行验证。**



























## 任务 2：修复提供商端并提高高可用性

可能得分：75 线索惩罚：-27 **可用得分：48**

------

检查我的进度

------

#### 背景

作为服务提供商，您希望您的服务具有高可用性。为此，您在注册到 Endpoint Service 的网络负载均衡器 (NLB) 上启用了 3 个可用区 (AZ)。但是，NLB 上的 3 个可用区中只有 2 个在运行。

#### 你的任务

您的任务是配置网络负载均衡器 (NLB)，以 在*所有三个可用区*中的*所有目标之间平均分配流量。*

解析 NLB 的 DNS 名称时，仅返回两个 IP 地址，而不是预期的三个。使用`dig`或命令对的**输出属性**`nslookup`中找到的 NLB DNS 名称进行验证。`NLBDomainName`

为了完成这个最后的任务，有两个核心目标：

1. 需要正确配置第三个可用区，以便解析 NLB DNS 名称返回所有三个 IP 地址。
2. 此外，网络负载均衡器 (NLB) 应将流量均匀分布在所有三个可用区中的健康目标之间。启用 NLB 上缺少的设置可确保这一点。

#### 架构图

[![任务 1 网络架构图](https://aws-jam-challenge-resources.s3.amazonaws.com/networking-private-link/Architecture-Diagram-v6.png) （点击图片在新标签页中打开）](https://aws-jam-challenge-resources.s3.amazonaws.com/networking-private-link/Architecture-Diagram-v6.png)

# 

#### 存货

###### **服务提供商**

**VPC**：名称 -**服务提供商 VPC**，CIDR - 20.0.0.0/16

- 子网
  - 子网 1：名称 - ProviderPrivateSubnet1，CIDR - 20.0.1.0/24
  - 子网 2：名称 - ProviderPrivateSubnet2，CIDR - 20.0.2.0/24
  - 子网 3：名称 - ProviderPrivateSubnet3，CIDR - 20.0.3.0/24

# 

**网络负载均衡器**：

- 名称 - **ServiceProviderNLB 。请参阅****输出属性**`NLBDomainName`中的DNS 名称的值。
- **目标群体**：
  - 名称 - **ProviderTargetGroup**

# 

- 网络负载均衡器目标
  - 名称 - TargetInstance1，子网 - ProviderPrivateSubnet1，私有 IP：20.0.1.10
  - 名称 - TargetInstance2，子网 - ProviderPrivateSubnet2，私有 IP：20.0.2.10
  - 名称 - TargetInstance3，子网 - ProviderPrivateSubnet3，私有 IP：20.0.3.10

#### 您应该使用的服务：

- Amazon 虚拟私有云 (VPC)
- Amazon 弹性计算云 (Amazon EC2)

#### 任务验证

要完成此任务，需要进行两项配置更改。进行必要的配置更改后，NLB 域应分别返回三个 IP 地址，每个 IP 地址对应三个可用区。此外，使用来自所有三个端点接口 IP 的 cURL 时，您应该会收到 200 OK 响应，表明所有可用区之间的连接成功。

完成这两项配置更改后，任务将在几分钟内自动标记为完成。不过，您也可以点击此页面顶部的**“检查我的进度”按钮来确认完成，而无需等待自动验证。**





### 解析

### 线索一：平衡法

------

隐藏

------

##### 目标问题

为了识别和解决根本原因，您应该彻底检查 AWS 管理控制台的 Elastic Load Balancing 功能中的详细信息以及受影响的 Amazon EC2 实例的配置。

##### 负载均衡器配置

为了确保网络负载均衡器 (NLB) 在所有健康目标之间均匀分配连接，无论目标位于哪个可用区 (AZ)，您都可以在 NLB 上配置特定设置。

启用此配置后，NLB 将在所有健康目标之间均匀分配流量，无论其 AZ 位置如何。这意味着，如果一个 AZ 的健康目标多于另一个 AZ，或者如果一个 AZ 根本没有健康目标，则连接将路由到可用目标。

为了确保网络负载均衡器 (NLB) 在所有健康目标之间均匀分配连接，无论目标位于哪个可用区 (AZ)，您都可以配置特定设置。启用此配置后，NLB 将在所有健康目标之间均匀分配流量，而不管其可用区位置如何。这意味着，如果一个可用区的健康目标多于另一个可用区，或者某个可用区根本没有健康目标，连接仍将路由到可用目标。







### 线索2：健康均衡

------

隐藏

------

目标问题比较目标实例 1、2 和 3 使用的安全组。您能发现差异吗？为了解决这一难题，您可以对现有安全组进行更改，或更改与实例关联的安全组。确保关联的安全组中存在必要的更改。注意：网络负载均衡器 (NLB) 不支持将安全组用于防火墙规则。因此，在此挑战中，您将无法将安全组引用为任何防火墙规则更改的流量来源。相反，您应该使用 CIDR 表示法为任何规则修改指定块或特定 IP 地址。
负载均衡器配置想要启用该特殊功能？您可以在官方[AWS 文档](https://docs.aws.amazon.com/elasticloadbalancing/latest/userguide/how-elastic-load-balancing-works.html)中找到提到的功能。





### 线索3：完整解决方案

------

隐藏

------

##### 目标问题

由于入站安全组规则，TargetInstance3 不允许进行健康检查或端口 8080 上的任何流量。

以下是更新与 TargetInstance3 关联的安全组的入站规则的步骤：

1. 打开 Amazon **VPC 控制台**。

2. 在导航窗格中，选择**安全组。**

3. 选择要更新的安全组**Security_Group_for_Target_3**。

4. 选择**操作、编辑入站规则。**

5. 选择**添加规则**并配置：

   - 对于**类型**，选择流量类型**自定义 TCP**

   - **端口**设置为**8080**

   - 

     将源

     指定为

     自定义

     ，CIDR 范围为

     20.0.0.0/16

     # 

6. 选择**保存规则。**

（或者）

1. 打开**EC2 控制台**。
2. 选择**实例**并选择**TargetInstance3**，然后单击**操作 > 安全 > 更改安全组**。
3. **在关联的安全组**部分中，搜索**Security_Group_for_Target_1_&_2**，选择并**添加安全组**。
4. 验证新的安全组关联

##### 负载均衡器配置

默认情况下，网络负载均衡器 (NLB) 上的[跨区域负载均衡](https://docs.aws.amazon.com/elasticloadbalancing/latest/userguide/how-elastic-load-balancing-works.html#cross-zone-load-balancing)处于禁用状态。这意味着 NLB 将仅将请求路由到与收到请求的可用区位于同一可用区内的目标。在客户端缓存区域 NLB 的 DNS 信息的情况下，某些目标可能会收到不成比例的大量入站请求。为确保在健康目标之间平衡连接分配，请在 NLB 上启用**跨区域负载均衡**。

以下是在网络负载均衡器上启用它的步骤：

1. 打开 AWS 管理控制台并导航到 EC2 服务。
2. 在导航窗格中的**“负载平衡”**部分下，单击**“负载平衡器”**。
3. 单击`ServiceProviderNLB`网络负载均衡器以打开查看并编辑其属性。
4. 单击**“属性”**选项卡并选择**“编辑”**。
5. 在**编辑负载均衡器属性**页面中，选择启用**跨区域负载均衡**。
6. 单击**“保存更改”**以应用配置。
7. ![image-20241020164549535](./img/image-20241020164549535.png)

------

#### 任务验证

进行必要的配置更改后，NLB 域应分别返回三个 IP 地址，每个 IP 地址对应三个可用区。此外，使用 cURL 从所有三个端点接口 IP 访问时，您应该会收到 200 OK 响应，表明所有可用区之间的连接均已成功。

完成这两项配置更改后，任务将在几分钟内自动标记为完成。不过，您也可以点击此页面顶部的**“检查我的进度”按钮来确认完成，而无需等待自动验证**





完成此任务需要更改三项配置。完成这些更改后，您应该能够看到来自 2 个端点接口 IP 的 cURL 命令的“200 OK”响应。

在看到成功的 cURL 响应后几分钟内，任务将自动标记为完成。一旦您认为解决方案已实施，您也可以点击**“检查我的进度”按钮。**

注意：如果您在入站规则中允许从 Internet（0.0.0.0/0）访问，则该任务**不会正式标记为完成。**